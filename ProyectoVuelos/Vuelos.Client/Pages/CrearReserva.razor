@page "/crear-reserva/{VueloId:int}"
@inject HttpClient Http
@inject NavigationManager Navigation
@using Vuelos.Shared

<div class="container mt-4" style="max-width: 600px;">
    <h3>📝 Nueva Reserva Manual</h3>

    @if (vuelo == null)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                Vuelo: @vuelo.Origen ➝ @vuelo.Destino
            </div>
            <div class="card-body">
                <p><strong>Fecha:</strong> @vuelo.Fecha @vuelo.Hora</p>
                <p><strong>Precio Base:</strong> @vuelo.Precio €</p>
                <hr />

                <div class="mb-3">
                    <label class="form-label">Nombre del Pasajero / Cliente:</label>
                    <input @bind="nuevaReserva.NombrePasajero" class="form-control" placeholder="Nombre completo" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Cantidad de Asientos:</label>
                    <input type="number" @bind="nuevaReserva.AsientosReservados" class="form-control" min="1" max="10" />
                </div>

                <div class="alert alert-secondary text-center">
                    Total a Cobrar: <strong>@(vuelo.Precio* nuevaReserva.AsientosReservados) €</strong>
                </div>

                @if (!string.IsNullOrEmpty(mensajeError))
                {
                    <div class="alert alert-danger mb-3 text-center">
                        ⚠️ @mensajeError
                    </div>
                }
                <div class="d-grid gap-2">
                    <button class="btn btn-success" @onclick="GuardarReserva">Confirmar Reserva</button>
                    <button class="btn btn-outline-secondary" @onclick="Volver">Cancelar</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int VueloId { get; set; }

    private VueloDto? vuelo;
    private Reserva nuevaReserva = new Reserva();
    private string? mensajeError;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            vuelo = await Http.GetFromJsonAsync<VueloDto>($"api/Vuelo/{VueloId}");
            nuevaReserva.VueloId = VueloId;
            nuevaReserva.AsientosReservados = 1;
        }
        catch (Exception ex)
        {
            mensajeError = "No se pudo cargar el vuelo.";
        }
    }

    private async Task GuardarReserva()
    {
        mensajeError = null;

        if (string.IsNullOrWhiteSpace(nuevaReserva.NombrePasajero))
        {
            mensajeError = "Por favor, escribe el nombre del pasajero.";
            return;
        }

        var respuesta = await Http.PostAsJsonAsync("api/Reserva", nuevaReserva);

        if (respuesta.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("reservas");
        }
        else
        {
            var error = await respuesta.Content.ReadAsStringAsync();
            mensajeError = string.IsNullOrEmpty(error) ? "Error al procesar la reserva." : error;
            Console.WriteLine($"Error: {mensajeError}");
        }
    }

    private void Volver() => Navigation.NavigateTo("vuelos");
}